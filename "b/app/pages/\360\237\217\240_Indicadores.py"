import asyncio

import pandas as pd
import plotly.express as px
import streamlit as st

from app.arkmeds_client.client import ArkmedsClient
from app.config.os_types import TIPO_CORRETIVA
from app.services.equip_metrics import compute_metrics as compute_equip_metrics
from app.services.os_metrics import compute_metrics as compute_os_metrics

from .filters import show_active_filters

filters = st.session_state["filters"]
version = st.session_state.get("filtros_version", 0)


@st.cache_data(ttl=900, experimental_allow_widgets=True)
async def fetch_all(v: int):
    client = ArkmedsClient.from_session()
    osm = await compute_os_metrics(client, **filters)
    eqm = await compute_equip_metrics(client, **filters)
    corr_hist = await client.os_monthly_history(tipo_id=TIPO_CORRETIVA, months=12)
    return osm, eqm, corr_hist


with st.spinner("Carregando indicadoresâ€¦"):
    osm, eqm, corr_hist = asyncio.run(fetch_all(version))

show_active_filters(ArkmedsClient.from_session())

if osm and eqm:
    corr_total = osm.corretivas_predial + osm.corretivas_engenharia
    prev_total = osm.preventivas_predial + osm.preventivas_infra
    pct_manut = round(eqm.em_manutencao / eqm.ativos * 100, 1) if eqm.ativos else 0.0

    items = [
        ("ğŸ”§ Corretivas (M)", corr_total),
        ("ğŸ› ï¸ Preventivas (M)", prev_total),
        ("ğŸ” Busca Ativa (M)", osm.busca_ativa),
        ("ğŸ“¦ Backlog Atual", osm.backlog),
        ("â±ï¸ MTTR Global (h)", eqm.mttr_h),
        ("ğŸ”„ MTBF Global (h)", eqm.mtbf_h),
        ("â±ï¸ SLA Global %", osm.sla_pct),
        ("ğŸš§ Equip. em Manut. %", pct_manut),
    ]
    for i in range(0, len(items), 4):
        cols = st.columns(4)
        for col, (label, value) in zip(cols, items[i : i + 4]):
            col.metric(label, value)
else:
    st.warning("MÃ©trica em implementaÃ§Ã£o")

hist_df = pd.DataFrame(corr_hist)
if not hist_df.empty:
    fig = px.line(
        hist_df,
        x="mes",
        y=["abertas", "fechadas"],
        markers=True,
        labels={"value": "OS", "mes": "MÃªs", "variable": ""},
        title="Corretivas Abertas x Fechadas (Ãºltimos 12 meses)",
    )
    st.plotly_chart(fig, use_container_width=True)
else:
    st.info("Curva de tendÃªncia em construÃ§Ã£o")

st.info("Heat-map SLA em construÃ§Ã£o")

col1, col2, col3, col4 = st.columns(4)
with col1:
    if st.button("Ver OS ğŸ“"):
        st.switch_page("pages/ğŸ“‘_Ordens_de_ServiÃ§o.py")
with col2:
    if st.button("Equipamentos âš™ï¸"):
        st.switch_page("pages/ğŸ› ï¸_Equipamentos.py")
with col3:
    if st.button("TÃ©cnicos ğŸ‘·"):
        st.switch_page("pages/ğŸ‘·_TÃ©cnicos.py")
with col4:
    st.button("RelatÃ³rios ğŸ“‘", disabled=True)
